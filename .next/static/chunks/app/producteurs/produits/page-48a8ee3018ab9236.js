(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[653],{1109:function(e,t,i){Promise.resolve().then(i.bind(i,3169))},3169:function(e,t,i){"use strict";i.d(t,{default:function(){return b}});var s=i(7437),a=i(2265),r=i(3145),l=i(4730),n=i(8822),o=i(6144);async function c(e,t){let i=new FormData;i.append("file",e);let s=await fetch(new URL("/api/v1/uploads/image","http://localhost:8000"),{method:"POST",headers:t?{Authorization:"Bearer ".concat(t)}:void 0,body:i,cache:"no-store"});if(!s.ok)throw Error("Upload failed: ".concat(s.status));return new URL((await s.json()).url,"http://localhost:8000").toString()}var u=i(1741),d=i(3404),p=i(8870);let m={title:"",description:"",category:"",region:"",origin:"",price:"",promoPrice:"",stock:"",impactCo2:"",dlcDate:"",status:"draft",isPublished:!1,images:[]};function g(e){var t,i,s,a,r,l,n;if(!e)return{...m};let o=null!==(t=e.priceCents)&&void 0!==t?t:Math.round(100*e.price);return{title:e.name,description:null!==(i=e.description)&&void 0!==i?i:"",category:null!==(s=e.category)&&void 0!==s?s:"",region:null!==(a=e.region)&&void 0!==a?a:"",origin:null!==(r=e.origin)&&void 0!==r?r:"",price:(o/100).toFixed(2),promoPrice:e.promoPriceCents?(e.promoPriceCents/100).toFixed(2):"",stock:"number"==typeof e.stock?String(e.stock):"",impactCo2:e.impactCo2Grams?String(e.impactCo2Grams):"",dlcDate:"",status:null!==(l=e.status)&&void 0!==l?l:"draft",isPublished:!!e.isPublished,images:null!==(n=e.images)&&void 0!==n?n:[]}}function h(e){let{isOpen:t,onClose:i,onSubmit:l,isSubmitting:n,initialProduct:o,authToken:u}=e,[p,m]=(0,a.useState)(()=>g(o)),[h,v]=(0,a.useState)(!1),[b,f]=(0,a.useState)(null);(0,a.useEffect)(()=>{m(g(o)),f(null)},[o]);let x=(e,t)=>{m(i=>({...i,[e]:t}))},y=async e=>{var t;let i=null===(t=e.target.files)||void 0===t?void 0:t[0];if(i){if(!u){f("Session expir\xe9e. Reconnectez-vous.");return}v(!0),f(null);try{let e=await c(i,u);m(t=>{let i=[...t.images,{url:e,isPrimary:0===t.images.length}];return{...t,images:i}})}catch(e){console.error("[ProducerProducts] Upload failed",e),f("T\xe9l\xe9versement impossible. R\xe9essayez avec une image plus l\xe9g\xe8re.")}finally{v(!1),e.target.value=""}}},j=e=>{m(t=>{let i=t.images.map((t,i)=>({...t,isPrimary:i===e}));return{...t,images:i}})},C=e=>{m(t=>{let i=t.images.filter((t,i)=>i!==e);return!i.some(e=>e.isPrimary)&&i.length>0&&(i[0]={...i[0],isPrimary:!0}),{...t,images:i}})};return(0,s.jsx)(d.Z,{isOpen:t,onClose:i,title:o?"Modifier le produit":"Ajouter un produit",actions:(0,s.jsx)("button",{className:"btn btn--primary",type:"submit",form:"producer-product-form",disabled:n,children:n?"Enregistrement...":o?"Mettre \xe0 jour":"Cr\xe9er"}),children:(0,s.jsxs)("form",{id:"producer-product-form",className:"grid",style:{gap:"var(--space-3)"},onSubmit:e=>{var t;e.preventDefault(),l(p,null!==(t=null==o?void 0:o.id)&&void 0!==t?t:null)},children:[(0,s.jsxs)("label",{className:"input-label",children:["Nom du produit",(0,s.jsx)("input",{className:"input",value:p.title,onChange:e=>x("title",e.target.value),required:!0})]}),(0,s.jsxs)("label",{className:"input-label",children:["Description",(0,s.jsx)("textarea",{className:"textarea",rows:3,value:p.description,onChange:e=>x("description",e.target.value)})]}),(0,s.jsxs)("div",{className:"grid",style:{gap:"var(--space-2)",gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))"},children:[(0,s.jsxs)("label",{className:"input-label",children:["Cat\xe9gorie",(0,s.jsx)("input",{className:"input",value:p.category,onChange:e=>x("category",e.target.value)})]}),(0,s.jsxs)("label",{className:"input-label",children:["R\xe9gion",(0,s.jsx)("input",{className:"input",value:p.region,onChange:e=>x("region",e.target.value)})]}),(0,s.jsxs)("label",{className:"input-label",children:["Origine / Unit\xe9",(0,s.jsx)("input",{className:"input",value:p.origin,onChange:e=>x("origin",e.target.value)})]})]}),(0,s.jsxs)("div",{className:"grid",style:{gap:"var(--space-2)",gridTemplateColumns:"repeat(auto-fit, minmax(160px, 1fr))"},children:[(0,s.jsxs)("label",{className:"input-label",children:["Prix (EUR)",(0,s.jsx)("input",{className:"input",type:"number",min:"0",step:"0.01",value:p.price,onChange:e=>x("price",e.target.value),required:!0})]}),(0,s.jsxs)("label",{className:"input-label",children:["Prix promo (EUR)",(0,s.jsx)("input",{className:"input",type:"number",min:"0",step:"0.01",value:p.promoPrice,onChange:e=>x("promoPrice",e.target.value)})]}),(0,s.jsxs)("label",{className:"input-label",children:["Stock",(0,s.jsx)("input",{className:"input",type:"number",min:"0",value:p.stock,onChange:e=>x("stock",e.target.value),required:!0})]}),(0,s.jsxs)("label",{className:"input-label",children:["Impact CO2 (g)",(0,s.jsx)("input",{className:"input",type:"number",min:"0",value:p.impactCo2,onChange:e=>x("impactCo2",e.target.value)})]})]}),(0,s.jsxs)("div",{className:"grid",style:{gap:"var(--space-2)",gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))"},children:[(0,s.jsxs)("label",{className:"input-label",children:["DLC (date limite)",(0,s.jsx)("input",{className:"input",type:"date",value:p.dlcDate,onChange:e=>x("dlcDate",e.target.value)})]}),(0,s.jsxs)("label",{className:"input-label",children:["Statut",(0,s.jsxs)("select",{className:"select",value:p.status,onChange:e=>x("status",e.target.value),children:[(0,s.jsx)("option",{value:"draft",children:"Brouillon"}),(0,s.jsx)("option",{value:"published",children:"Publi\xe9"}),(0,s.jsx)("option",{value:"archived",children:"Archiv\xe9"})]})]}),(0,s.jsxs)("label",{className:"checkbox",style:{alignSelf:"flex-end"},children:[(0,s.jsx)("input",{type:"checkbox",checked:p.isPublished,onChange:e=>x("isPublished",e.target.checked)}),"Visible dans le catalogue"]})]}),(0,s.jsxs)("div",{className:"grid",style:{gap:"var(--space-2)"},children:[(0,s.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,s.jsx)("strong",{children:"Images"}),(0,s.jsxs)("label",{className:"btn btn--ghost",style:{cursor:"pointer"},children:[h?"T\xe9l\xe9versement...":"Ajouter une image",(0,s.jsx)("input",{type:"file",accept:"image/*",onChange:y,style:{display:"none"},disabled:h})]})]}),b?(0,s.jsx)("div",{className:"alert alert--warning",children:b}):null,0===p.images.length?(0,s.jsx)("p",{className:"muted",children:"Ajoutez au moins une image pour mettre en avant votre lot."}):(0,s.jsx)("div",{className:"grid",style:{gap:"var(--space-2)"},children:p.images.map((e,t)=>(0,s.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",border:"1px solid var(--border-muted)",padding:"var(--space-2)",borderRadius:8},children:[(0,s.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"var(--space-2)"},children:[(0,s.jsx)(r.default,{src:e.url,alt:"Aper\xe7u produit",width:64,height:64,style:{width:64,height:64,objectFit:"cover",borderRadius:6}}),(0,s.jsx)("span",{className:"muted",style:{fontSize:"var(--fs-small)"},children:e.isPrimary?"Image principale":"Miniature"})]}),(0,s.jsxs)("div",{style:{display:"flex",gap:"var(--space-2)"},children:[e.isPrimary?null:(0,s.jsx)("button",{className:"btn btn--ghost",type:"button",onClick:()=>j(t),children:"D\xe9finir principale"}),(0,s.jsx)("button",{className:"btn btn--ghost",type:"button",onClick:()=>C(t),children:"Supprimer"})]})]},e.url))})]})]})})}function v(){var e,t;let{user:i}=(0,l.a)(),{showToast:r}=(0,p.p)(),[c,u]=(0,a.useState)(1),[d,m]=(0,a.useState)([]),[g,v]=(0,a.useState)(0),[b,f]=(0,a.useState)(!1),[x,y]=(0,a.useState)(null),[j,C]=(0,a.useState)(!1),[P,N]=(0,a.useState)(null),[_,S]=(0,a.useState)(!1),w=null!==(t=null===(e=(0,n.Z6)())||void 0===e?void 0:e.accessToken)&&void 0!==t?t:null,k=(0,a.useCallback)(()=>{w&&(f(!0),y(null),(0,o.sJ)(w,{limit:10,offset:(c-1)*10}).then(e=>{m(e.items),v(e.total)}).catch(e=>{console.error("[ProducerProducts] Failed to fetch products",e),y("Impossible de r\xe9cup\xe9rer vos produits.")}).finally(()=>f(!1)))},[w,c]);(0,a.useEffect)(()=>{w&&k()},[w,k]);let D=Math.max(1,Math.ceil(g/10)),E=e=>{N(e),C(!0)},I=()=>{C(!1),N(null)},T=async(e,t)=>{if(!w){r("Session expir\xe9e. Reconnectez-vous.","warning");return}try{S(!0);let i={title:e.title,description:e.description||null,category:e.category||null,region:e.region||null,origin:e.origin||null,dlcDate:e.dlcDate||null,impactCo2Grams:e.impactCo2?Number(e.impactCo2):null,priceCents:Math.round(100*Number(e.price||0)),promoPriceCents:e.promoPrice?Math.round(100*Number(e.promoPrice)):null,stock:Number(e.stock||0),status:e.status,isPublished:e.isPublished,images:e.images.map(e=>({url:e.url,isPrimary:e.isPrimary}))};t?(await (0,o.et)(w,t,i),r("Produit mis \xe0 jour","success")):(await (0,o.J8)(w,i),r("Produit cr\xe9\xe9 avec succ\xe8s","success")),I(),k()}catch(e){console.error("[ProducerProducts] Submit failed",e),r("Impossible d'enregistrer le produit.","error")}finally{S(!1)}},R=async e=>{if(w&&window.confirm('Supprimer le produit "'.concat(e.name,'" ?')))try{await (0,o.ud)(w,e.id),r("Produit supprim\xe9.","success"),k()}catch(e){console.error("[ProducerProducts] Delete failed",e),r("Suppression impossible.","error")}},M=async e=>{if(!w)return;let t=!e.isPublished;try{await (0,o.et)(w,e.id,{isPublished:t,status:t?"published":"draft"}),r(t?"Produit publi\xe9":"Produit masqu\xe9","success"),k()}catch(e){console.error("[ProducerProducts] Toggle publish failed",e),r("Action impossible.","error")}};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("main",{className:"container",style:{display:"grid",gap:"var(--space-12)"},children:(0,s.jsx)("section",{className:"section",children:(0,s.jsxs)("div",{style:{display:"grid",gap:"var(--space-3)"},children:[(0,s.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:"var(--space-2)"},children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"badge badge--impact",children:"Espace producteur"}),(0,s.jsx)("h1",{style:{marginTop:"var(--space-2)"},children:"Mes produits"}),(0,s.jsx)("p",{className:"muted",children:"Publiez et mettez \xe0 jour vos lots en quelques clics."})]}),(0,s.jsxs)("div",{style:{display:"flex",gap:"var(--space-2)",flexWrap:"wrap"},children:[(0,s.jsx)("button",{className:"btn btn--primary",type:"button",onClick:()=>{N(null),C(!0)},children:"Ajouter un produit"}),(0,s.jsx)("span",{className:"muted",style:{alignSelf:"center"},children:b?"Chargement...":"".concat(g," produit").concat(g>1?"s":"")})]})]}),x?(0,s.jsx)("div",{className:"alert alert--warning",children:x}):null,0!==d.length||b?(0,s.jsx)("div",{className:"grid",style:{gap:"var(--space-3)"},children:d.map(e=>{var t;return(0,s.jsxs)("article",{className:"card",style:{display:"grid",gap:"var(--space-2)"},children:[(0,s.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",gap:"var(--space-2)",flexWrap:"wrap"},children:[(0,s.jsx)("strong",{children:e.name}),(0,s.jsx)("span",{className:"badge",children:null!==(t=e.status)&&void 0!==t?t:"draft"})]}),(0,s.jsxs)("div",{className:"muted",style:{fontSize:"var(--fs-small)"},children:[e.category||"Sans cat\xe9gorie"," \xb7 ",e.region||"R\xe9gion n/d"]}),(0,s.jsxs)("div",{style:{display:"flex",gap:"var(--space-2)",flexWrap:"wrap"},children:[(0,s.jsx)("span",{children:"number"==typeof e.priceCents?"".concat((e.priceCents/100).toFixed(2)," EUR"):"".concat(e.price.toFixed(2)," EUR")}),"number"==typeof e.stock?(0,s.jsxs)("span",{children:["Stock : ",e.stock]}):null,e.isPublished?(0,s.jsx)("span",{className:"badge badge--impact",children:"Publi\xe9"}):(0,s.jsx)("span",{className:"badge badge--secondary",children:"Masqu\xe9"})]}),(0,s.jsxs)("div",{style:{display:"flex",gap:"var(--space-2)",flexWrap:"wrap"},children:[(0,s.jsx)("button",{className:"btn btn--ghost",type:"button",onClick:()=>E(e),children:"Modifier"}),(0,s.jsx)("button",{className:"btn btn--ghost",type:"button",onClick:()=>M(e),children:e.isPublished?"Masquer":"Publier"}),(0,s.jsx)("button",{className:"btn btn--ghost",type:"button",onClick:()=>R(e),children:"Supprimer"})]})]},e.id)})}):(0,s.jsx)("p",{className:"muted",children:"Commencez par ajouter votre premier produit."}),(0,s.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:"var(--space-2)"},children:[(0,s.jsx)("button",{className:"btn btn--ghost",type:"button",disabled:c<=1||b,onClick:()=>u(e=>Math.max(1,e-1)),children:"Pr\xe9c\xe9dent"}),(0,s.jsxs)("span",{className:"muted",children:["Page ",c," / ",D]}),(0,s.jsx)("button",{className:"btn btn--ghost",type:"button",disabled:c>=D||b,onClick:()=>u(e=>e+1),children:"Suivant"})]})]})})}),(0,s.jsx)(h,{isOpen:j,onClose:I,onSubmit:T,isSubmitting:_,initialProduct:P,authToken:w})]})}function b(){return(0,s.jsx)(u.Z,{requireAuth:!0,requiredRole:"producer",children:()=>(0,s.jsx)(v,{})})}},8870:function(e,t,i){"use strict";i.d(t,{V:function(){return l},p:function(){return n}});var s=i(7437),a=i(2265);let r=(0,a.createContext)(void 0);function l(e){let{children:t}=e,[i,l]=(0,a.useState)([]),n=(0,a.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3e3,s="".concat(Date.now(),"-").concat(Math.random());l(a=>[...a,{id:s,message:e,type:t,timeoutMs:i}]),window.setTimeout(()=>{l(e=>e.filter(e=>e.id!==s))},i)},[]),o=(0,a.useMemo)(()=>({showToast:n}),[n]);return(0,s.jsxs)(r.Provider,{value:o,children:[t,(0,s.jsx)("div",{style:{position:"fixed",right:16,bottom:16,display:"grid",gap:"8px",zIndex:1e3},"aria-live":"polite","aria-atomic":!0,children:i.map(e=>(0,s.jsx)("div",{className:"alert ".concat("success"===e.type?"alert--success":"warning"===e.type?"alert--warning":"error"===e.type?"alert--warning":""),role:"status",children:e.message},e.id))})]})}function n(){let e=(0,a.useContext)(r);if(!e)throw Error("useToast must be used within ToastProvider");return e}},6144:function(e,t,i){"use strict";i.d(t,{Au:function(){return u},J8:function(){return n},VP:function(){return r},et:function(){return o},sJ:function(){return l},ud:function(){return c}});var s=i(9116),a=i(2139);async function r(e){let t=await (0,s.S)("/producer/insights",{authToken:e});return{totalOrders:t.total_orders,totalRevenueCents:t.total_revenue_cents,totalItemsSold:t.total_items_sold,averageOrderValueCents:t.average_order_value_cents,totalImpactCo2Grams:t.total_impact_co2_g,topProducts:t.top_products.map(e=>{var t;return{productId:e.product_id,title:e.title,revenueCents:e.revenue_cents,unitsSold:e.units_sold,averageRating:null!==(t=e.average_rating)&&void 0!==t?t:null}})}}async function l(e){var t,i;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},l=await (0,s.S)("/producer/products",{authToken:e,params:{limit:null!==(t=r.limit)&&void 0!==t?t:20,offset:null!==(i=r.offset)&&void 0!==i?i:0}});return{items:l.items.map(a.fm),total:l.total,limit:l.limit,offset:l.offset}}async function n(e,t){var i,r,l,n,o,c,u,d,p;let m={title:t.title,price_cents:t.priceCents,stock:t.stock,description:null!==(i=t.description)&&void 0!==i?i:null,category:null!==(r=t.category)&&void 0!==r?r:null,region:null!==(l=t.region)&&void 0!==l?l:null,origin:null!==(n=t.origin)&&void 0!==n?n:null,dlc_date:null!==(o=t.dlcDate)&&void 0!==o?o:null,impact_co2_g:null!==(c=t.impactCo2Grams)&&void 0!==c?c:null,promo_price_cents:null!==(u=t.promoPriceCents)&&void 0!==u?u:null,is_published:null!==(d=t.isPublished)&&void 0!==d&&d,images:(null!==(p=t.images)&&void 0!==p?p:[]).map(e=>({url:e.url,is_primary:!!e.isPrimary}))};t.status&&(m.status=t.status);let g=await (0,s.S)("/products",{method:"POST",authToken:e,body:JSON.stringify(m)});return(0,a.fm)(g)}async function o(e,t,i){let r={};void 0!==i.title&&(r.title=i.title),void 0!==i.description&&(r.description=i.description),void 0!==i.category&&(r.category=i.category),void 0!==i.region&&(r.region=i.region),void 0!==i.origin&&(r.origin=i.origin),void 0!==i.dlcDate&&(r.dlc_date=i.dlcDate),void 0!==i.impactCo2Grams&&(r.impact_co2_g=i.impactCo2Grams),void 0!==i.priceCents&&(r.price_cents=i.priceCents),void 0!==i.promoPriceCents&&(r.promo_price_cents=i.promoPriceCents),void 0!==i.stock&&(r.stock=i.stock),void 0!==i.status&&(r.status=i.status),void 0!==i.isPublished&&(r.is_published=i.isPublished);let l=await (0,s.S)("/producer/products/".concat(t),{method:"PUT",authToken:e,body:JSON.stringify(r)});return(0,a.fm)(l)}async function c(e,t){await (0,s.S)("/producer/products/".concat(t),{method:"DELETE",authToken:e})}async function u(e){var t,i;let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=await (0,s.S)("/producer/orders",{authToken:e,params:{limit:null!==(t=a.limit)&&void 0!==t?t:20,offset:null!==(i=a.offset)&&void 0!==i?i:0}});return{items:r.items.map(e=>({orderId:e.order_id,status:e.status,customerId:e.customer_id,customerEmail:e.customer_email,createdAt:e.created_at,totalAmountCents:e.total_amount_cents,lines:e.lines.map(e=>{var t;return{id:e.id,orderId:e.order_id,productId:e.product_id,productTitle:e.product_title,quantity:e.quantity,unitPriceCents:e.unit_price_cents,referencePriceCents:null!==(t=e.reference_price_cents)&&void 0!==t?t:null,subtotalCents:e.subtotal_cents,createdAt:e.created_at}})})),total:r.total,limit:r.limit,offset:r.offset}}}},function(e){e.O(0,[972,697,741,971,117,744],function(){return e(e.s=1109)}),_N_E=e.O()}]);