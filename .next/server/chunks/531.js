"use strict";exports.id=531,exports.ids=[531],exports.modules={1551:(e,a,t)=>{t.d(a,{Z:()=>l});var s=t(326),r=t(7577),i=t(962);function l({isOpen:e,onClose:a,title:t,children:l,actions:n}){let o=(0,r.useId)(),c=(0,r.useRef)(null),d=(0,r.useRef)(null),[u,p]=(0,r.useState)(null);if((0,r.useCallback)(e=>{"Escape"===e.key&&(e.preventDefault(),a())},[a]),!e||!u)return null;let m=s.jsx("div",{className:"modal is-open",role:"dialog","aria-modal":"true","aria-labelledby":o,onClick:a,children:(0,s.jsxs)("div",{className:"modal__panel",ref:c,onClick:e=>e.stopPropagation(),children:[(0,s.jsxs)("header",{className:"modal__header",children:[s.jsx("h3",{id:o,children:t}),s.jsx("button",{className:"modal__close",type:"button",onClick:a,"aria-label":"Fermer la fenetre",ref:d,children:"X"})]}),s.jsx("div",{children:l}),n?s.jsx("div",{className:"modal__actions",children:n}):null]})});return(0,i.createPortal)(m,u)}},2531:(e,a,t)=>{t.d(a,{Z:()=>V});var s=t(326),r=t(7577),i=t(5047),l=t(8358),n=t(3391),o=t(9571),c=t(6824);async function d(e){return(0,c.S)("/cart",{authToken:e})}async function u(e,a){return(0,c.S)("/cart",{method:"PUT",authToken:e,body:JSON.stringify(a.map(e=>({product_id:e.productId,quantity:e.quantity})))})}async function p(e){await (0,c.S)("/cart",{method:"DELETE",authToken:e})}var m=t(2924);async function h(e,a){return(0,c.S)("/payments/init",{method:"POST",authToken:e,body:JSON.stringify(a)})}let g={category:"",region:"",availability:"",query:"",priceMin:null,priceMax:null,dlcMaxDays:null,sort:"newest"},x={orders:0,co2:0,savings:0,weeklySavings:0},y=(e,a)=>{let t=new Set(e);return a.forEach(e=>{e&&t.add(e)}),Array.from(t).sort((e,a)=>e.localeCompare(a,"fr",{sensitivity:"base"}))},f=e=>"number"==typeof e&&Number.isFinite(e)?e:void 0,b=e=>""!==e.availability,j=(e,a)=>{let t=b(e);return{query:e.query||void 0,category:e.category||void 0,region:e.region||void 0,dlcWithinDays:f(e.dlcMaxDays),priceMin:f(e.priceMin),priceMax:f(e.priceMax),limit:t?100:12,offset:t?0:(a-1)*12,sort:e.sort}},v=e=>e.reduce((e,a)=>(e.totalPrice+=a.price*a.quantity,e.totalCo2+=a.co2Saved*a.quantity,e),{totalPrice:0,totalCo2:0}),C=()=>"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():`order-${Date.now()}-${Math.random()}`;var k=t(1551);let N={email:"",password:"",firstName:"",lastName:"",region:"",role:"consumer",consentNewsletter:!1,consentAnalytics:!1};function S({mode:e,isOpen:a,onClose:t}){let{login:i,register:n}=(0,l.a)(),[o,c]=(0,r.useState)(N),[d,u]=(0,r.useState)(null),[p,m]=(0,r.useState)(!1),h=async a=>{a.preventDefault(),m(!0),u(null);let{email:s,password:r,firstName:i,lastName:l,region:n,role:c,consentAnalytics:d,consentNewsletter:p}=o;try{if("login"===e){let e=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,password:r})}),a=await e.json();if(!e.ok){console.log(a.error||"Erreur de connexion");return}localStorage.setItem("token",a.token),console.log("Connexion r\xe9ussie !"),window.location.href="/"}else{console.log("Registering user:",o);let e=await fetch("/api/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,password:r,firstName:i,lastName:l,region:n,role:c,consentNewsletter:p,consentAnalytics:d})}),a=await e.json();if(!e.ok){console.log(a.error||"Erreur \xe0 l'inscription");return}console.log("Inscription r\xe9ussie",a),window.location.href="/"}t()}finally{m(!1)}},g=(e,a)=>{c(t=>({...t,[e]:a}))};return a?s.jsx(k.Z,{isOpen:a,onClose:t,title:"login"===e?"Se connecter":"Creer un compte",children:(0,s.jsxs)("form",{className:"grid",onSubmit:h,style:{gap:"var(--space-3)"},children:["register"===e?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"grid",style:{gap:"var(--space-2)"},children:[(0,s.jsxs)("label",{className:"input-label",children:["Prenom",s.jsx("input",{className:"input",placeholder:"Prenom",value:o.firstName,onChange:e=>g("firstName",e.target.value)})]}),(0,s.jsxs)("label",{className:"input-label",children:["Nom",s.jsx("input",{className:"input",placeholder:"Nom",value:o.lastName,onChange:e=>g("lastName",e.target.value)})]})]}),(0,s.jsxs)("label",{className:"input-label",children:["Region",s.jsx("input",{className:"input",placeholder:"Region (ex: Ile-de-France)",value:o.region,onChange:e=>g("region",e.target.value)})]}),(0,s.jsxs)("label",{className:"input-label",children:["Type de compte",(0,s.jsxs)("select",{className:"select",value:o.role,onChange:e=>g("role",e.target.value),required:!0,children:[s.jsx("option",{value:"consumer",children:"Consommateur"}),s.jsx("option",{value:"producer",children:"Producteur"})]})]})]}):null,(0,s.jsxs)("label",{className:"input-label",children:["Email",s.jsx("input",{className:"input",type:"email",value:o.email,onChange:e=>g("email",e.target.value),required:!0,autoComplete:"email"})]}),(0,s.jsxs)("label",{className:"input-label",children:["Mot de passe",s.jsx("input",{className:"input",type:"password",value:o.password,onChange:e=>g("password",e.target.value),required:!0,minLength:8,autoComplete:"login"===e?"current-password":"new-password"})]}),"register"===e?(0,s.jsxs)("div",{className:"grid",style:{gap:"var(--space-2)"},children:[(0,s.jsxs)("label",{className:"checkbox",children:[s.jsx("input",{type:"checkbox",checked:o.consentNewsletter,onChange:e=>g("consentNewsletter",e.target.checked)}),s.jsx("span",{children:"Recevoir les actualites GreenCart"})]}),(0,s.jsxs)("label",{className:"checkbox",children:[s.jsx("input",{type:"checkbox",checked:o.consentAnalytics,onChange:e=>g("consentAnalytics",e.target.checked)}),s.jsx("span",{children:"Partager mes donnees d'usage pour le suivi d'impact"})]})]}):null,d?s.jsx("p",{style:{color:"var(--danger-500, #c43d3d)",margin:0,fontSize:"var(--fs-small)"},children:d}):null,s.jsx("button",{className:"btn btn--primary",type:"submit",disabled:p,children:p?"Veuillez patienter...":"login"===e?"Se connecter":"Creer mon compte"})]})}):null}var w=t(4746),_=t(1315),q=t(7084),P=t(9418);function M({isOpen:e,onClose:a,items:t,totalPrice:r,totalCo2:i,onDecrease:l,onIncrease:n,onRemove:o,onEmpty:c,onCheckout:d,isProcessing:u=!1,errorMessage:p=null}){return(0,s.jsxs)(k.Z,{isOpen:e,onClose:a,title:"Mon panier",actions:(0,s.jsxs)(s.Fragment,{children:[s.jsx("button",{className:"btn",type:"button",onClick:a,children:"Continuer mes achats"}),s.jsx("button",{className:"btn btn--primary",type:"button",onClick:d,disabled:0===t.length||u,children:u?"Traitement...":"Passer au paiement"})]}),children:[p?s.jsx("div",{className:"alert alert--warning",role:"status",children:p}):null,(0,s.jsxs)("div",{className:"cart-summary",children:[(0,s.jsxs)("strong",{children:["Total : ",r.toFixed(2)," EUR"]}),s.jsx("button",{className:"btn btn--ghost",type:"button",onClick:c,children:"Vider"})]}),s.jsx("div",{className:"cart-list",children:0===t.length?s.jsx("p",{className:"muted",children:"Votre panier est vide pour l'instant."}):t.map(e=>(0,s.jsxs)("article",{className:"cart-item",children:[(0,s.jsxs)("div",{className:"cart-item__header",children:[s.jsx("strong",{children:e.name}),(0,s.jsxs)("span",{className:"muted",children:[e.region," - ",e.unit]})]}),(0,s.jsxs)("div",{className:"cart-item__controls",children:[(0,s.jsxs)("div",{className:"cart-item__quantity",children:[s.jsx("button",{className:"btn btn--ghost",type:"button",onClick:()=>l(e.id),"aria-label":"Diminuer la quantite",children:s.jsx(w.Z,{size:16,strokeWidth:1.5,"aria-hidden":!0})}),(0,s.jsxs)("span",{children:[e.quantity," x ",e.price.toFixed(2)," EUR"]}),s.jsx("button",{className:"btn btn--ghost",type:"button",onClick:()=>n(e.id),"aria-label":"Augmenter la quantite",children:s.jsx(_.Z,{size:16,strokeWidth:1.5,"aria-hidden":!0})})]}),(0,s.jsxs)("button",{className:"btn btn--danger",type:"button",onClick:()=>o(e.id),children:[s.jsx(q.Z,{size:16,strokeWidth:1.5,"aria-hidden":!0}),"Retirer"]})]}),(0,s.jsxs)("div",{className:"cart-item__impact",children:[s.jsx(P.Z,{size:16,strokeWidth:1.5,"aria-hidden":!0}),(0,s.jsxs)("span",{children:["Impact evite : ",(e.co2Saved*e.quantity).toFixed(1)," kg CO2e"]})]})]},e.id))}),(0,s.jsxs)("div",{className:"cart-footer",children:[(0,s.jsxs)("span",{className:"muted",children:["Total CO2e evite : ",i.toFixed(1)," kg"]}),s.jsx("span",{className:"muted",children:"Livraison responsable incluse (demo)"})]})]})}var I=t(6226),A=t(434);function F(){let e=new Date().getFullYear();return(0,s.jsxs)("footer",{className:"site-footer",role:"contentinfo",children:[(0,s.jsxs)("div",{className:"container footer-grid",children:[(0,s.jsxs)("section",{"aria-label":"A propos",children:[(0,s.jsxs)("div",{className:"brand",style:{marginBottom:"10px"},children:[s.jsx(I.default,{src:"/images/logo.png",alt:"Logo GreenCart",className:"logo",width:44,height:44}),s.jsx("strong",{children:"GreenCart"})]}),s.jsx("p",{className:"muted",children:"Plateforme sobre qui relie producteurs engages et foyers responsables, avec un suivi d'impact en temps reel."}),(0,s.jsxs)("ul",{"aria-label":"Reseaux sociaux",style:{display:"flex",gap:"10px",listStyle:"none",padding:0,margin:"10px 0 0"},children:[s.jsx("li",{children:s.jsx("a",{href:"https://twitter.com","aria-label":"X (Twitter)",children:"X"})}),s.jsx("li",{children:s.jsx("a",{href:"https://instagram.com","aria-label":"Instagram",children:"Instagram"})}),s.jsx("li",{children:s.jsx("a",{href:"https://linkedin.com","aria-label":"LinkedIn",children:"LinkedIn"})})]})]}),(0,s.jsxs)("section",{"aria-label":"Navigation",children:[s.jsx("strong",{children:"Navigation"}),(0,s.jsxs)("ul",{className:"footer-links",children:[s.jsx("li",{children:s.jsx(A.default,{href:{pathname:"/",hash:"marque"},children:"Plateforme de marque"})}),s.jsx("li",{children:s.jsx(A.default,{href:"/catalogue",children:"Catalogue"})}),s.jsx("li",{children:s.jsx(A.default,{href:{pathname:"/",hash:"dashboard"},children:"Mon impact"})}),s.jsx("li",{children:s.jsx(A.default,{href:"/producteurs",children:"Espace producteur"})}),s.jsx("li",{children:s.jsx(A.default,{href:"/aide",children:"Aide & FAQ"})})]})]}),(0,s.jsxs)("section",{"aria-label":"Mentions legales",children:[s.jsx("strong",{children:"Legal"}),(0,s.jsxs)("ul",{className:"footer-links",children:[s.jsx("li",{children:s.jsx("a",{href:"#",children:"Mentions legales"})}),s.jsx("li",{children:s.jsx("a",{href:"#",children:"Conditions d'utilisation"})}),s.jsx("li",{children:s.jsx("a",{href:"#",children:"Politique de confidentialite"})}),s.jsx("li",{children:s.jsx("a",{href:"#",children:"Cookies"})})]})]}),(0,s.jsxs)("section",{"aria-label":"Contact",children:[s.jsx("strong",{children:"Contact"}),(0,s.jsxs)("address",{style:{fontStyle:"normal"},children:[s.jsx("a",{href:"mailto:hello@greencart.local",children:"hello@greencart.local"}),s.jsx("br",{}),"Ile-de-France, France"]}),s.jsx("p",{className:"muted",children:"Support du lundi au vendredi - 9h-18h."})]})]}),(0,s.jsxs)("div",{className:"container footer-bottom",children:[(0,s.jsxs)("span",{children:["(c) ",e," GreenCart. Tous droits reserves."]}),s.jsx("span",{children:"SIREN 000 000 000 - Demonstration."})]})]})}var D=t(3020),T=t(8026);let E={consumer:"Consommateur",producer:"Producteur",admin:"Admin"},R=[{label:"Accueil",href:"/"},{label:"Valeurs",href:"/valeurs"},{label:"Catalogue",href:"/catalogue"},{label:"Producteurs",href:"/producteurs"},{label:"Aide",href:"/aide"}],z={consumer:[{label:"Compte",href:"/compte"},{label:"Avis",href:"/compte/avis"},{label:"Commandes",href:"/compte/commandes"},{label:"Impact",href:"/compte/impact"},{label:"Aide",href:"/aide"}],producer:[{label:"Dashboard",href:"/producteurs/dashboard"},{label:"Mes produits",href:"/producteurs/produits"},{label:"Commandes",href:"/producteurs/commandes"},{label:"Recommandations IA",href:"/producteurs/recommandations"},{label:"Aide",href:"/aide"}],admin:[{label:"Analytics",href:"/admin/analytics"},{label:"BI",href:"/admin/bi"},{label:"Donn\xe9es publiques",href:"/admin/public-data"},{label:"Rapports",href:"/admin/reports"},{label:"Utilisateurs",href:"/admin/utilisateurs"}]};function O({cartCount:e,onOpenCart:a,onOpenLogin:t,onOpenRegister:i,onLogout:l,user:n,isAuthenticating:o,isScrolled:c}){let[d,u]=(0,r.useState)(!1),p=(0,r.useMemo)(()=>n&&n.role?z[n.role]??[]:[],[n]),m=(0,r.useMemo)(()=>n?.role==="admin"||n?.role==="producer"||n?.role==="consumer"?p:[...R,...p],[n,p]),h=()=>{u(!1)},g=async()=>{try{localStorage.removeItem("token"),window.location.href="/"}catch(e){console.error("Erreur lors de l'appel logout",e)}},[x,y]=(0,r.useState)(null);return s.jsx("header",{className:`site-header${c?" is-scrolled":""}`,children:(0,s.jsxs)("div",{className:"container nav",children:[(0,s.jsxs)("div",{className:"brand",children:[s.jsx(I.default,{src:"/images/logo.png",alt:"Logo GreenCart",className:"logo",width:44,height:44}),s.jsx(A.default,{href:"/",className:"brand-name",onClick:h,children:"GreenCart"}),s.jsx("span",{className:"muted",style:{fontSize:"var(--fs-small)"}})]}),(0,s.jsxs)("button",{className:"header-toggle",type:"button","aria-expanded":d,"aria-controls":"navigation-principale",onClick:()=>{u(e=>!e)},children:[d?s.jsx(D.Z,{size:22,strokeWidth:1.5,"aria-hidden":!0}):s.jsx(T.Z,{size:22,strokeWidth:1.5,"aria-hidden":!0}),s.jsx("span",{className:"sr-only",children:d?"Fermer le menu":"Ouvrir le menu"})]}),(0,s.jsxs)("div",{className:`header-menus${d?" is-open":""}`,children:[s.jsx("nav",{id:"navigation-principale",className:"navlinks",role:"navigation","aria-label":"Navigation principale",children:m.map(e=>s.jsx(A.default,{href:e.href,onClick:h,children:e.label},e.label))}),x?s.jsx("div",{className:"nav-actions",children:(0,s.jsxs)("div",{style:{display:"flex",gap:"var(--space-2)",alignItems:"center",flexWrap:"wrap",margin:"auto"},children:[(0,s.jsxs)("button",{className:"btn btn--ghost",type:"button",onClick:()=>{a(),h()},children:["Mon panier (",e,")"]}),(0,s.jsxs)("p",{style:{color:"green",fontWeight:"bold"},children:[" ",x.firstName," ",x.lastName]}),s.jsx("button",{onClick:g,className:"btn btn--primary",type:"button",children:"Se deconnecter"})]})}):(0,s.jsxs)("div",{className:"nav-actions",children:[n?.role!=="consumer"&&n?null:(0,s.jsxs)("button",{className:"btn btn--ghost",type:"button",onClick:()=>{a(),h()},children:["Mon panier (",e,")"]}),n?(0,s.jsxs)("div",{style:{display:"flex",gap:"var(--space-2)",alignItems:"center",flexWrap:"wrap"},children:[s.jsx("div",{className:"badge badge--ghost",children:E[n.role]}),s.jsx("span",{className:"muted",style:{fontSize:"var(--fs-small)"},children:[n.firstName,n.lastName].filter(Boolean).join(" ").trim()||n.email}),s.jsx("button",{className:"btn btn--ghost",type:"button",onClick:()=>{l?.(),h()},disabled:o,children:o?"Chargement...":"Se deconnecter"})]}):(0,s.jsxs)("div",{style:{display:"flex",gap:"var(--space-2)",flexWrap:"wrap",alignItems:"center"},children:[s.jsx("button",{className:"btn btn--ghost",type:"button",onClick:()=>{t(),h()},children:"Se connecter"}),s.jsx("button",{className:"btn btn--primary",type:"button",onClick:()=>{i(),h()},children:"Creer un compte"})]})]})]})]})})}var L=t(9102),Z=t(5249),W=t(7670);function $({product:e,afterDescription:a}){var t;let r=(t=e.dlcDays)<=3?"DLC proche : planifiez votre consommation.":t<=7?"A consommer dans la semaine.":"DLC confortable pour vos menus a venir.";return(0,s.jsxs)("div",{style:{display:"grid",gap:"var(--space-4)"},children:[s.jsx(I.default,{src:e.image,alt:e.name,width:680,height:420,sizes:"(max-width: 900px) 90vw, 640px",style:{width:"100%",height:"auto",borderRadius:"var(--radius-lg)",border:"1px solid var(--gc-border)",objectFit:"cover"},priority:!0}),(0,s.jsxs)("div",{className:"grid",style:{gap:"var(--space-3)"},children:[(0,s.jsxs)("div",{className:"meta",style:{display:"flex",gap:"var(--space-4)",flexWrap:"wrap"},children:[(0,s.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"var(--space-2)"},children:[s.jsx(L.Z,{size:18,strokeWidth:1.5,"aria-hidden":!0}),s.jsx("span",{children:e.unit})]}),(0,s.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"var(--space-2)"},children:[s.jsx(Z.Z,{size:18,strokeWidth:1.5,"aria-hidden":!0}),s.jsx("span",{children:e.region})]})]}),(0,s.jsxs)("div",{style:{display:"flex",flexWrap:"wrap",gap:"var(--space-3)"},children:[(0,s.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"var(--space-2)"},children:[s.jsx(P.Z,{size:18,strokeWidth:1.5,"aria-hidden":!0}),(0,s.jsxs)("strong",{children:[e.co2Saved.toFixed(1)," kg CO2e evites"]})]}),(0,s.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"var(--space-2)"},children:[s.jsx(W.Z,{size:18,strokeWidth:1.5,"aria-hidden":!0}),(0,s.jsxs)("span",{children:["DLC ",e.dlcDays," jours"]})]})]}),(0,s.jsxs)("div",{className:"alert alert--warning",role:"status",children:[s.jsx(W.Z,{size:18,strokeWidth:1.5,"aria-hidden":!0}),(0,s.jsxs)("div",{children:[s.jsx("strong",{style:{display:"block"},children:"Conseil anti-gaspi"}),s.jsx("span",{children:r})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("strong",{children:[e.price.toFixed(2)," EUR"]}),s.jsx("p",{className:"muted",style:{marginTop:"var(--space-2)"},children:e.description})]}),a]})]})}function U({product:e,isOpen:a,onClose:t,onAddToCart:r}){if(!e)return null;let i="number"==typeof e.stock&&e.stock<=0;return s.jsx(k.Z,{isOpen:a,onClose:t,title:e.name,actions:s.jsx("button",{className:"btn btn--primary",type:"button",disabled:i,"aria-disabled":i,onClick:()=>{i||r(e)},children:i?"Rupture":"Ajouter au panier"}),children:s.jsx($,{product:e})})}var G=t(710);function V({children:e,initialFilters:a,requireAuth:c=!1,requiredRole:f}){let k=function(e){let{user:a}=(0,l.a)(),s=!!a,c=(0,i.useRouter)(),[f,k]=(0,r.useState)({...g,...e??{}}),[N,S]=(0,r.useState)(1),[w,_]=(0,r.useState)([]),[q,P]=(0,r.useState)([]),[M,I]=(0,r.useState)(0),[A,F]=(0,r.useState)([]),[D,T]=(0,r.useState)([]),[E,R]=(0,r.useState)(!1),[z,O]=(0,r.useState)([]),[L,Z]=(0,r.useState)(()=>v([])),[W,$]=(0,r.useState)(!1),[U,G]=(0,r.useState)(null),[V,B]=(0,r.useState)(null),[J,Q]=(0,r.useState)(!1),[X,Y]=(0,r.useState)(null),[H,K]=(0,r.useState)(x),ee=(0,r.useRef)(new Map),ea=(0,r.useRef)([]),et=(0,r.useRef)(0),[es,er]=(0,r.useState)(null),ei=(0,r.useCallback)(async e=>{let a=ee.current.get(e);if(a)return a;try{let a=await (0,o.dQ)(e);if(a)return ee.current.set(a.id,a),a}catch(e){console.error("[useShoppingExperience] Failed to fetch product",e)}return null},[]),el=(0,r.useCallback)(async e=>({...await ei(e.product_id)??{id:e.product_id,slug:String(e.product_id),name:e.product_title,price:e.unit_price_cents/100,region:"France",category:"Produit",availability:"normal",co2Saved:0,dlcDays:0,unit:"Unite",image:"https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=1200&auto=format&fit=crop",description:""},price:e.unit_price_cents/100,priceCents:e.unit_price_cents,quantity:e.quantity}),[ei]),en=(0,r.useCallback)(e=>{F(a=>y(a,e.map(e=>e.category))),T(a=>y(a,e.map(e=>e.region)))},[]);(0,r.useCallback)(async(e,a)=>{R(!0);try{let t=j(e,a),s=await (0,o.t2)(t);en(s.items);let r=e.availability&&e.availability.length>0?s.items.filter(a=>a.availability===e.availability):s.items,i=b(e)?r.slice((a-1)*12,12*a):r;_(i),P(r),I(b(e)?r.length:s.total)}catch(e){console.error("[useShoppingExperience] Failed to fetch products",e),_([]),P([]),I(0)}finally{R(!1)}},[en]);let eo=(0,r.useMemo)(()=>q.filter(e=>"surplus"===e.availability).slice(0,3),[q]),ec=(0,r.useMemo)(()=>q.reduce((e,a)=>e+a.co2Saved,0),[q]),ed=(0,r.useMemo)(()=>3*q.reduce((e,a)=>e+a.price,0),[q]),eu=(0,r.useMemo)(()=>z.reduce((e,a)=>e+a.quantity,0),[z]),ep=(0,r.useCallback)(async()=>{let e=(0,n.Z6)();if(!e){Z(v(ea.current));return}let a=++et.current;$(!0),G(null);try{let t=await d(e.accessToken),s=await Promise.all(t.items.map(el));if(et.current!==a)return;O(s),Z({totalPrice:t.total_amount_cents/100,totalCo2:v(s).totalCo2})}catch(e){if(et.current!==a)return;console.error("[useShoppingExperience] Failed to load cart",e),G("Impossible de synchroniser le panier. Vos ajouts restent locaux."),Z(v(ea.current))}finally{et.current===a&&$(!1)}},[el]),em=(0,r.useCallback)(async(e,a)=>{let t=(0,n.Z6)();if(!t){Z(a);return}let s=++et.current;$(!0),G(null);try{let a=await u(t.accessToken,e.map(e=>({productId:e.id,quantity:e.quantity})));if(et.current!==s)return;let r=await Promise.all(a.items.map(el));O(r),Z({totalPrice:a.total_amount_cents/100,totalCo2:v(r).totalCo2})}catch(r){if(et.current!==s)return;console.error("[useShoppingExperience] Failed to sync cart",r);let t=r&&"object"==typeof r&&"payload"in r&&r.payload&&"object"==typeof r.payload&&"detail"in r.payload?r.payload.detail:null;G("string"==typeof t?t:"Synchronisation du panier impossible. Vos modifications restent locales."),Z(a),O(e)}finally{et.current===s&&$(!1)}},[el]),eh=(0,r.useCallback)(e=>{O(a=>{let t=e(a),r=v(t);return er(null),Z(r),s&&em(t,r),t})},[s,em]),eg=(0,r.useCallback)(e=>{eh(a=>a.find(a=>a.id===e.id)?a.map(a=>a.id===e.id?{...a,quantity:a.quantity+1}:a):[...a,{...e,quantity:1}])},[eh]),ex=(0,r.useCallback)(e=>{eh(a=>a.map(a=>a.id===e?{...a,quantity:a.quantity-1}:a).filter(e=>e.quantity>0))},[eh]),ey=(0,r.useCallback)(e=>{eh(a=>a.map(a=>a.id===e?{...a,quantity:a.quantity+1}:a))},[eh]),ef=(0,r.useCallback)(e=>{eh(a=>a.filter(a=>a.id!==e))},[eh]),eb=(0,r.useCallback)(()=>{if(eh(()=>[]),s){let e=(0,n.Z6)();e&&p(e.accessToken)}},[eh,s]),ej=(0,r.useCallback)(()=>{Q(!0)},[]),ev=(0,r.useCallback)(()=>{Q(!1)},[]),eC=(0,r.useCallback)(e=>{B(e)},[]),ek=(0,r.useCallback)(()=>{B(null)},[]),eN=(0,r.useCallback)(()=>{if(0===ea.current.length)return;if(!s){Y("login");return}let e=(0,n.Z6)();if(!e){Y("login");return}let a={items:ea.current.map(e=>({product_id:e.id,quantity:e.quantity}))};er(null),$(!0),G(null),(0,m.LV)(e.accessToken,a,C()).then(async a=>{try{let t=window.location.origin,s=await h(e.accessToken,{order_id:a.id,provider:"stripe",success_url:`${t}/payment/success`,cancel_url:`${t}/payment/cancel`});window.location.href=s.checkout_url;return}catch(e){console.warn("[useShoppingExperience] Stripe init failed, falling back to manual flow",e)}O([]),Z({totalPrice:0,totalCo2:0}),K(e=>({orders:e.orders+1,co2:e.co2+a.totalImpactCo2Grams/1e3,savings:e.savings+a.totalAmountCents/100,weeklySavings:e.weeklySavings})),Q(!1),er(`Commande #${a.id} validee ! Total ${(a.totalAmountCents/100).toFixed(2)} ${a.currency}. Merci pour votre achat.`);try{let{trackPurchase:e}=await Promise.resolve().then(t.bind(t,710));e({orderId:a.id,currency:a.currency,totalCents:a.totalAmountCents})}catch{}try{await p(e.accessToken)}catch(e){console.error("[useShoppingExperience] Failed to clear remote cart after order",e),G("Le panier distant n'a pas pu etre nettoye. Actualisez la page si besoin.")}await ep();try{c.push(`/compte/commandes?order=${a.id}&success=1`)}catch{}}).catch(e=>{console.error("[useShoppingExperience] Checkout failed",e),G("Impossible de finaliser la commande. Merci de reessayer."),er(null)}).finally(()=>{$(!1)})},[s,ep]),eS=(0,r.useCallback)(()=>{let e=8+22*Math.random();K(a=>({...a,weeklySavings:a.weeklySavings+e}))},[]),ew=(0,r.useCallback)(e=>{S(1),k(e)},[]);return{filters:f,setFilters:ew,resetFilters:(0,r.useCallback)(()=>{k(g),S(1)},[]),categories:A,regions:D,featuredProducts:eo,filteredProducts:w,totalProducts:M,page:N,pageSize:12,setPage:S,isLoadingProducts:E,cartItems:z,cartCount:eu,cartTotals:L,isCartSyncing:W,cartError:U,addToCart:eg,decreaseItem:ex,increaseItem:ey,removeItem:ef,emptyCart:eb,isCartOpen:J,openCart:ej,closeCart:ev,selectedProduct:V,openProduct:eC,closeProduct:ek,handleCheckout:eN,metrics:H,simulateWeek:eS,totalCo2:ec,totalSavings:ed,producersCount:42,authModal:X,openAuthModal:(0,r.useCallback)(e=>{Y(e)},[]),closeAuthModal:(0,r.useCallback)(()=>{Y(null)},[]),checkoutSuccess:es}}(a),N=(0,i.useRouter)(),{user:w,logout:_,isAuthenticating:q}=(0,l.a)(),[P,I]=(0,r.useState)(!1),{authModal:A,closeAuthModal:D}=k;k.isCartOpen||null!==A||k.selectedProduct;let T=(0,r.useMemo)(()=>!f||!!w&&(Array.isArray(f)?f:[f]).includes(w.role),[w,f]),E=!q&&c&&(!w||!T);return(0,s.jsxs)(s.Fragment,{children:[s.jsx(O,{cartCount:k.cartCount,onOpenCart:k.openCart,onOpenLogin:()=>k.openAuthModal("login"),onOpenRegister:()=>k.openAuthModal("register"),onLogout:_,isScrolled:P,user:w,isAuthenticating:q}),q?s.jsx("main",{className:"container",style:{display:"grid",gap:"var(--space-12)"},"aria-busy":"true",children:s.jsx("section",{className:"section",children:s.jsx("div",{className:"skeleton-block",style:{height:200}})})}):E?s.jsx("main",{className:"container",style:{display:"grid",gap:"var(--space-12)"},children:s.jsx("section",{className:"section",children:(0,s.jsxs)("div",{style:{display:"grid",gap:"var(--space-3)"},children:[(0,s.jsxs)("div",{children:[s.jsx("div",{className:"badge badge--impact",children:"Acc\xe8s prot\xe9g\xe9"}),s.jsx("h1",{style:{marginTop:"var(--space-2)"},children:"Veuillez vous connecter"}),(0,s.jsxs)("p",{className:"muted",children:["Cette section est r\xe9serv\xe9e aux utilisateurs authentifi\xe9s",f?" avec le r\xf4le appropri\xe9":"","."]})]}),(0,s.jsxs)("div",{style:{display:"flex",gap:"var(--space-2)",flexWrap:"wrap"},children:[s.jsx("button",{className:"btn btn--primary",type:"button",onClick:()=>k.openAuthModal("login"),children:"Se connecter"}),s.jsx("button",{className:"btn btn--secondary",type:"button",onClick:()=>k.openAuthModal("register"),children:"Cr\xe9er un compte"})]})]})})}):e(k),s.jsx(F,{}),s.jsx(M,{isOpen:k.isCartOpen,onClose:k.closeCart,items:k.cartItems,totalPrice:k.cartTotals.totalPrice,totalCo2:k.cartTotals.totalCo2,onDecrease:k.decreaseItem,onIncrease:k.increaseItem,onRemove:k.removeItem,onEmpty:k.emptyCart,onCheckout:()=>{try{let e=k.cartItems.map(e=>({id:e.id,quantity:e.quantity,priceCents:e.priceCents??null})),a=Math.round(100*k.cartTotals.totalPrice);(0,G.Z_)({totalCents:a,items:e})}catch{}k.closeCart(),N.push("/checkout")},isProcessing:k.isCartSyncing,errorMessage:k.cartError}),s.jsx(U,{isOpen:null!==k.selectedProduct,product:k.selectedProduct,onClose:k.closeProduct,onAddToCart:e=>{k.addToCart(e),k.closeProduct()}}),s.jsx(S,{mode:"register"===A?"register":"login",isOpen:null!==A&&!w,onClose:D})]})}},9571:(e,a,t)=>{t.d(a,{dQ:()=>l,t2:()=>i,fm:()=>n});var s=t(6824);let r=[{id:1,slug:"pommes-moches-5-kg",name:"Pommes moches (5 kg)",price:6.5,region:"Ile-de-France",category:"Fruits",availability:"surplus",co2Saved:2.1,dlcDays:6,unit:"Colis 5 kg",image:"https://images.unsplash.com/photo-1576402187878-974f70c890a5?q=80&w=1200&auto=format&fit=crop",description:"Pommes hors calibre issues d'une recolte locale. Ideales pour compotes, jus et patisseries anti-gaspi."},{id:2,slug:"legumes-varies-b-4-kg",name:"Legumes varies B (4 kg)",price:7.9,region:"Hauts-de-France",category:"Legumes",availability:"surplus",co2Saved:2.9,dlcDays:4,unit:"Panier 4 kg",image:"https://images.unsplash.com/photo-1515542706656-8e6ef17a1521?q=80&w=1200&auto=format&fit=crop",description:"Panier de legumes biscornus recoltes le matin meme. Varietes adapteees aux soupes et poelees familiales."},{id:3,slug:"yaourts-fermiers-x12",name:"Yaourts fermiers (x12)",price:5.5,region:"Bretagne",category:"Cremerie",availability:"normal",co2Saved:.6,dlcDays:3,unit:"Lot x12",image:"https://images.unsplash.com/photo-1551024601-bec78aea704b?q=80&w=1200&auto=format&fit=crop",description:"Yaourts nature au lait entier, texture genereuse. Date courte mais qualite garantie par la ferme."},{id:4,slug:"pains-de-la-veille-x4",name:"Pains de la veille (x4)",price:2,region:"Ile-de-France",category:"Boulangerie",availability:"surplus",co2Saved:1.2,dlcDays:1,unit:"Lot x4",image:"https://images.unsplash.com/photo-1549931319-a545dcf3bc73?q=80&w=1200&auto=format&fit=crop",description:"Pains tradition de la veille, croustillants apres quelques minutes au four. Emballage compostable."},{id:5,slug:"tomates-irregulieres-3-kg",name:"Tomates irregulieres (3 kg)",price:4.9,region:"Provence-Alpes-Cote d'Azur",category:"Legumes",availability:"surplus",co2Saved:2.3,dlcDays:5,unit:"Cagette 3 kg",image:"https://images.unsplash.com/photo-1567306226416-28f0efdc88ce?q=80&w=1200&auto=format&fit=crop",description:"Tomates anciennes aux formes originales. Saveur ensoleillee, parfaites en salade ou en sauce."},{id:6,slug:"fromage-de-chevre-demi-sec",name:"Fromage de chevre demi-sec",price:3.9,region:"Auvergne-Rhone-Alpes",category:"Cremerie",availability:"normal",co2Saved:.4,dlcDays:10,unit:"Unite 250 g",image:"https://images.unsplash.com/photo-1505575972945-2804b5c35f33?q=80&w=1200&auto=format&fit=crop",description:"Fromage de chevre demi-sec affine 10 jours. Gout franc, lait issu d'un elevage extensif."}];async function i(e={}){let a={q:e.query,category:e.category,region:e.region,dlc_lte_days:e.dlcWithinDays,price_min:e.priceMin,price_max:e.priceMax,limit:e.limit,offset:e.offset,sort:e.sort};try{let e=await (0,s.S)("/products",{params:a});return{items:e.items.map(n),total:e.total,limit:e.limit,offset:e.offset}}catch(e){return console.warn("[products] falling back to local mock data",e),{items:r,total:r.length,limit:r.length,offset:0}}}async function l(e){try{let a=await (0,s.S)(`/products/${e}`);return n(a)}catch(e){if(e instanceof Error&&"status"in e&&404===e.status)return null;throw e}}function n(e){var a;let t=e.images.length>0?e.images:[],s=t.find(e=>e.is_primary)?.url??t[0]?.url??"https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=1200&auto=format&fit=crop";return{id:e.id,slug:`${e.id}-${e.title}`.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),name:e.title,price:Math.round(e.promo_price_cents??e.price_cents)/100,region:e.region??"France",category:e.category??"Autres",availability:e.stock>0?"normal":"surplus",co2Saved:null==(a=e.impact_co2_g)?0:Math.max(Math.round(a)/1e3,0),dlcDays:function(e){if(!e)return 0;let a=new Date;return Math.max(Math.ceil((new Date(e).getTime()-a.setHours(0,0,0,0))/864e5),0)}(e.dlc_date),unit:e.origin??"Unite",image:s,description:e.description??"",images:t.map(e=>({url:e.url,isPrimary:e.is_primary})),origin:e.origin,stock:e.stock,status:e.status,isPublished:e.is_published,impactCo2Grams:e.impact_co2_g,priceCents:e.price_cents,promoPriceCents:e.promo_price_cents}}}};